<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Smart Loan DApp</title>
		<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 700px;
				margin: 40px auto;
				padding: 20px;
				border: 1px solid #ccc;
				border-radius: 10px;
			}
			input,
			select {
				margin: 6px 0;
				width: 100%;
				padding: 8px;
			}
			button {
				padding: 10px 20px;
				margin-top: 10px;
				cursor: pointer;
			}
			.status {
				margin-top: 10px;
				font-weight: bold;
				color: green;
			}
			.timer {
				font-weight: bold;
				color: red;
			}
			.loan-item {
				border: 1px solid #aaa;
				padding: 10px;
				margin-bottom: 10px;
			}
		</style>
	</head>
	<body>
		<h2>üîó Smart Loan DApp</h2>
		<button onclick="connectWallet()">
			üîå K·∫øt n·ªëi MetaMask
		</button>
		<div
			id="walletAddress"
			class="status"></div>

		<h3>üîë Vai tr√≤</h3>
		<select
			id="role"
			onchange="renderRoleUI()">
			<option value="none">
				-- Ch·ªçn vai tr√≤ --
			</option>
			<option value="borrower">
				Ng∆∞·ªùi vay
			</option>
			<option value="lender">
				Ng∆∞·ªùi cho vay
			</option>
		</select>

		<div
			id="borrowerUI"
			style="display: none">
			<h3>üì§ G·ª≠i y√™u c·∫ßu vay</h3>
			<input
				id="amount"
				placeholder="S·ªë ti·ªÅn vay (ETH)" />
			<input
				id="interest"
				placeholder="L√£i su·∫•t (%)" />
			<input
				id="dueInSeconds"
				placeholder="Th·ªùi gian ƒë√°o h·∫°n (gi√¢y t·ª´ b√¢y gi·ªù)" />
			<button onclick="requestLoan()">
				G·ª≠i y√™u c·∫ßu vay
			</button>
		</div>

		<div
			id="lenderUI"
			style="display: none">
			<h3>üí∏ Danh s√°ch kho·∫£n vay</h3>
			<div id="loanList"></div>

			<h3>
				üìú L·ªãch s·ª≠ kho·∫£n vay ƒë√£ cho
			</h3>
			<pre id="loanHistoryLender">
ƒêang t·∫£i...</pre
			>
		</div>

		<div
			id="status"
			class="status"></div>

		<script>
			const contractAddress =
				'0x384c1e04a67da065e12b9d8a02de93b05f205c1e'
			const abi = [
				'function requestLoan(uint amount, uint interest, uint dueDate) public',
				'function acceptLoan(uint index) public payable',
				'function repayLoan(uint index) public payable',
				'function getLoanCount() public view returns (uint)',
				'function getLoanDetails(uint index) public view returns (address,address,uint,uint,uint,bool,bool)',
			]

			let provider,
				signer,
				contract,
				currentAccount

			async function connectWallet() {
				if (window.ethereum) {
					provider =
						new ethers.providers.Web3Provider(
							window.ethereum,
							'sepolia'
						)
					await provider.send(
						'eth_requestAccounts',
						[]
					)
					signer = provider.getSigner()
					currentAccount =
						await signer.getAddress()
					document.getElementById(
						'walletAddress'
					).innerText = `üü¢ ƒê√£ k·∫øt n·ªëi: ${currentAccount}`
					contract =
						new ethers.Contract(
							contractAddress,
							abi,
							signer
						)
					loadLoans()
					loadLoanHistoryLender()
				} else {
					alert('B·∫°n c·∫ßn c√†i MetaMask!')
				}
			}

			function renderRoleUI() {
				const role =
					document.getElementById(
						'role'
					).value
				document.getElementById(
					'borrowerUI'
				).style.display =
					role === 'borrower'
						? 'block'
						: 'none'
				document.getElementById(
					'lenderUI'
				).style.display =
					role === 'lender'
						? 'block'
						: 'none'
			}

			async function requestLoan() {
				const amount =
					document.getElementById(
						'amount'
					).value
				const interest =
					document.getElementById(
						'interest'
					).value
				const dueIn =
					document.getElementById(
						'dueInSeconds'
					).value
				const dueTimestamp =
					Math.floor(
						Date.now() / 1000
					) + parseInt(dueIn)

				try {
					const tx =
						await contract.requestLoan(
							ethers.utils.parseEther(
								amount
							),
							parseInt(interest),
							dueTimestamp
						)
					await tx.wait()
					showStatus(
						'‚úÖ G·ª≠i y√™u c·∫ßu vay th√†nh c√¥ng'
					)
					loadLoans()
					loadLoanHistoryLender()
				} catch (err) {
					showStatus(
						'‚ùå L·ªói y√™u c·∫ßu vay: ' +
							err.message
					)
				}
			}

			async function loadLoans() {
				try {
					const loanListEl =
						document.getElementById(
							'loanList'
						)
					if (!contract) return
					const count =
						await contract.getLoanCount()
					loanListEl.innerHTML = ''
					for (
						let i = 0;
						i < count;
						i++
					) {
						const [
							lender,
							borrower,
							amount,
							interest,
							dueDate,
							accepted,
							repaid,
						] =
							await contract.getLoanDetails(
								i
							)
						const now = Math.floor(
							Date.now() / 1000
						)
						const secondsLeft =
							dueDate - now
						const status = repaid
							? '‚úÖ ƒê√£ tr·∫£'
							: accepted
							? 'üì§ ƒê√£ vay'
							: '‚è≥ Ch∆∞a cho vay'
						const div =
							document.createElement(
								'div'
							)
						div.className = 'loan-item'
						div.innerHTML = `
              <b>Kho·∫£n vay #${i}</b><br/>
              Ng∆∞·ªùi vay: ${borrower}<br/>
              S·ªë ti·ªÅn: ${ethers.utils.formatEther(
								amount
							)} ETH<br/>
              L√£i su·∫•t: ${interest}%<br/>
              ƒê√°o h·∫°n: ${new Date(
								dueDate * 1000
							).toLocaleString()}<br/>
              <span class="timer">C√≤n l·∫°i: ${secondsLeft}s</span><br/>
              Tr·∫°ng th√°i: ${status}<br/>
              ${
								!accepted
									? `<button onclick="acceptLoan(${i})">Ch·∫•p nh·∫≠n & G·ª≠i ETH</button>`
									: ''
							}
              ${
								accepted && !repaid
									? `<button onclick="repayLoan(${i})">Tr·∫£ g·ªëc + l√£i</button>`
									: ''
							}
            `
						loanListEl.appendChild(div)
					}
				} catch (err) {
					console.error(err)
				}
			}

			async function acceptLoan(index) {
				try {
					const [, , amount] =
						await contract.getLoanDetails(
							index
						)
					const tx =
						await contract.acceptLoan(
							index,
							{ value: amount }
						)
					await tx.wait()
					showStatus(
						'‚úÖ Ch·∫•p nh·∫≠n kho·∫£n vay th√†nh c√¥ng'
					)
					loadLoans()
					loadLoanHistoryLender()
				} catch (err) {
					showStatus(
						'‚ùå L·ªói ch·∫•p nh·∫≠n: ' +
							err.message
					)
				}
			}

			async function repayLoan(index) {
				try {
					const [, , amount, interest] =
						await contract.getLoanDetails(
							index
						)
					const repay = amount.add(
						amount
							.mul(interest)
							.div(100)
					)
					const tx =
						await contract.repayLoan(
							index,
							{ value: repay }
						)
					await tx.wait()
					showStatus(
						'üíµ Tr·∫£ n·ª£ th√†nh c√¥ng'
					)
					loadLoans()
					loadLoanHistoryLender()
				} catch (err) {
					showStatus(
						'‚ùå L·ªói tr·∫£ n·ª£: ' +
							err.message
					)
				}
			}

			async function loadLoanHistoryLender() {
				try {
					const count =
						await contract.getLoanCount()
					let result = ''
					for (
						let i = 0;
						i < count;
						i++
					) {
						const [
							lender,
							borrower,
							amount,
							interest,
							dueDate,
							accepted,
							repaid,
						] =
							await contract.getLoanDetails(
								i
							)
						if (
							lender.toLowerCase() ===
							currentAccount.toLowerCase()
						) {
							result += `Kho·∫£n #${i} - Ng∆∞·ªùi vay: ${borrower} - S·ªë ti·ªÅn: ${ethers.utils.formatEther(
								amount
							)} ETH - Tr·∫°ng th√°i: ${
								repaid
									? '‚úÖ ƒê√£ tr·∫£'
									: '‚è≥ Ch∆∞a tr·∫£'
							}\n`
						}
					}
					document.getElementById(
						'loanHistoryLender'
					).innerText =
						result ||
						'Kh√¥ng c√≥ kho·∫£n n√†o ƒë√£ cho vay.'
				} catch (err) {
					document.getElementById(
						'loanHistoryLender'
					).innerText =
						'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.'
				}
			}

			function showStatus(msg) {
				document.getElementById(
					'status'
				).innerText = msg
			}
		</script>
	</body>
</html>
